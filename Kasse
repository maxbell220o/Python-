import RPi.GPIO as GPIO
from mfrc522 import SimpleMFRC522

# RFID-Reader initialisieren
reader = SimpleMFRC522()

# 🔐 Substitutionsverschlüsselungstabelle
ENCODE_MAP = {'0': 'j', '1': 'a', '2': 'b', '3': 'c', '4': 'd', 
              '5': 'e', '6': 'f', '7': 'g', '8': 'h', '9': 'i', '.' : 'x'}
DECODE_MAP = {v: k for k, v in ENCODE_MAP.items()}  # Umkehrung für Entschlüsselung

def encrypt_data(data):
    """Ersetzt Zahlen durch Buchstaben"""
    return ''.join(ENCODE_MAP.get(char, char) for char in data)

def decrypt_data(data):
    """Ersetzt Buchstaben zurück in Zahlen"""
    return ''.join(DECODE_MAP.get(char, char) for char in data)

try:
    while True:
        function = input("\nWas wollen Sie machen? [z = zahlen; g = Geld aufladen; k = Karten lesen; s = stoppen]: ").strip().lower()
        
        if function == "s":
            print("Programm wird beendet...")
            break

        elif function == "g":
            print("\n💳 Halte die Karte an den Leser...")  
            id, encrypted_money = reader.read()
            encrypted_money = encrypted_money.strip()

            money = decrypt_data(encrypted_money)
            print(f"🔄 Aktuelles Guthaben: {money} €")
            
            new_money = input("💰 Neues Geld hinzufügen: ")
            total_money = str(float(money) + float(new_money))

            encrypted_total_money = encrypt_data(total_money)

            print("💾 Schreibe neuen Betrag auf die Karte...")
            reader.write(encrypted_total_money)
            print(f"✅ Guthaben erfolgreich auf {total_money} € aktualisiert!")

        elif function == "z":
            while True:
                print("\n💳 Halte die Karte an den Leser...")  
                id, encrypted_money = reader.read()
                encrypted_money = encrypted_money.strip()
                
                money = decrypt_data(encrypted_money)
                print(f"💰 Aktuelles Guthaben: {money} €")
                
                payment_amount = input("💸 Betrag der Zahlung (oder 's' zum Abbrechen): ")
                if payment_amount.lower() == "s":
                    print("↩️ Zurück zum Start...")
                    break
                
                remaining_money = str(float(money) - float(payment_amount))
                if float(remaining_money) < 0:
                    print("❌ Nicht genug Guthaben!")
                    continue

                encrypted_remaining_money = encrypt_data(remaining_money)

                print("💾 Schreibe neuen Betrag auf die Karte...")
                reader.write(encrypted_remaining_money)
                print(f"✅ Zahlung erfolgreich! Neues Guthaben: {remaining_money} €")
                break

        elif function == "k":
            print("\n💳 Halte die Karte an den Leser...")  
            id, encrypted_money = reader.read()
            encrypted_money = encrypted_money.strip()
            
            money = decrypt_data(encrypted_money)
            print(f"📄 Karten-ID: {id}")
            print(f"💰 Guthaben: {money} €")
            print("✅ Lesen erfolgreich!")

        else:
            print("❌ Keine bekannte Funktion ausgewählt!")

finally:
    GPIO.cleanup()
