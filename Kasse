import RPi.GPIO as GPIO
from mfrc522 import SimpleMFRC522

# RFID-Reader initialisieren
reader = SimpleMFRC522()

# ğŸ” SubstitutionsverschlÃ¼sselungstabelle
ENCODE_MAP = {'0': 'j', '1': 'a', '2': 'b', '3': 'c', '4': 'd', 
              '5': 'e', '6': 'f', '7': 'g', '8': 'h', '9': 'i', '.' : 'x'}
DECODE_MAP = {v: k for k, v in ENCODE_MAP.items()}  # Umkehrung fÃ¼r EntschlÃ¼sselung

def encrypt_data(data):
    """Ersetzt Zahlen durch Buchstaben"""
    return ''.join(ENCODE_MAP.get(char, char) for char in data)

def decrypt_data(data):
    """Ersetzt Buchstaben zurÃ¼ck in Zahlen"""
    return ''.join(DECODE_MAP.get(char, char) for char in data)

try:
    while True:
        function = input("\nWas wollen Sie machen? [z = zahlen; g = Geld aufladen; k = Karten lesen; s = stoppen]: ").strip().lower()
        
        if function == "s":
            print("Programm wird beendet...")
            break

        elif function == "g":
            print("\nğŸ’³ Halte die Karte an den Leser...")  
            id, encrypted_money = reader.read()
            encrypted_money = encrypted_money.strip()

            money = decrypt_data(encrypted_money)
            print(f"ğŸ”„ Aktuelles Guthaben: {money} â‚¬")
            
            new_money = input("ğŸ’° Neues Geld hinzufÃ¼gen: ")
            total_money = str(float(money) + float(new_money))

            encrypted_total_money = encrypt_data(total_money)

            print("ğŸ’¾ Schreibe neuen Betrag auf die Karte...")
            reader.write(encrypted_total_money)
            print(f"âœ… Guthaben erfolgreich auf {total_money} â‚¬ aktualisiert!")

        elif function == "z":
            while True:
                print("\nğŸ’³ Halte die Karte an den Leser...")  
                id, encrypted_money = reader.read()
                encrypted_money = encrypted_money.strip()
                
                money = decrypt_data(encrypted_money)
                print(f"ğŸ’° Aktuelles Guthaben: {money} â‚¬")
                
                payment_amount = input("ğŸ’¸ Betrag der Zahlung (oder 's' zum Abbrechen): ")
                if payment_amount.lower() == "s":
                    print("â†©ï¸ ZurÃ¼ck zum Start...")
                    break
                
                remaining_money = str(float(money) - float(payment_amount))
                if float(remaining_money) < 0:
                    print("âŒ Nicht genug Guthaben!")
                    continue

                encrypted_remaining_money = encrypt_data(remaining_money)

                print("ğŸ’¾ Schreibe neuen Betrag auf die Karte...")
                reader.write(encrypted_remaining_money)
                print(f"âœ… Zahlung erfolgreich! Neues Guthaben: {remaining_money} â‚¬")
                break

        elif function == "k":
            print("\nğŸ’³ Halte die Karte an den Leser...")  
            id, encrypted_money = reader.read()
            encrypted_money = encrypted_money.strip()
            
            money = decrypt_data(encrypted_money)
            print(f"ğŸ“„ Karten-ID: {id}")
            print(f"ğŸ’° Guthaben: {money} â‚¬")
            print("âœ… Lesen erfolgreich!")

        else:
            print("âŒ Keine bekannte Funktion ausgewÃ¤hlt!")

finally:
    GPIO.cleanup()
